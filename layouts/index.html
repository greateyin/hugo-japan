{{ define "main" }}
{{ partial "cloud_background.html" . }}
{{- $ti := site.Params.tech_insights -}}

{{/* Add tech-insights class to body via JavaScript */}}
<script>document.body.classList.add('tech-insights');</script>

{{/* Hero Carousel Section - Reading from news directory */}}
{{ if site.Params.hero.enable }}
<section class="ti-hero" id="home">
  {{/* Get news articles from current language's news section */}}
  {{ $newsArticles := where site.RegularPages "Section" "news" }}
  {{ $newsArticles = $newsArticles.ByDate.Reverse }}
  {{ $newsArticles = first 5 $newsArticles }}

  {{/* Build slides from news articles */}}
  {{ $slides := slice }}
  {{ $newsLink := "/news/" | relLangURL }}
  {{ range $newsArticles }}
  {{ $slide := dict
  "title" .Title
  "subtitle" (default .Description (.Summary | plainify | truncate 150))
  "image" (default "images/hero-tech.jpg" .Params.image)
  "badge" (index (default (slice "News") .Params.categories) 0)
  "primary_button_text" (i18n "read_more" | default "Read More")
  "primary_button_link" .Permalink
  "secondary_button_text" (i18n "view_all_news" | default "All News")
  "secondary_button_link" $newsLink
  }}
  {{ $slides = $slides | append $slide }}
  {{ end }}

  {{/* Fallback to config slides if no news articles */}}
  {{ if eq (len $slides) 0 }}
  {{ $slides = site.Params.hero.slides }}
  {{ end }}

  {{/* Final fallback to legacy config */}}
  {{ if not $slides }}
  {{ $slides = slice (dict
  "image" site.Params.hero.background_image
  "badge" site.Params.hero.badge
  "title" (printf "%s %s" site.Params.hero.title_prefix site.Params.hero.title_highlight)
  "subtitle" site.Params.hero.subtitle
  "primary_button_text" site.Params.hero.primary_button
  "primary_button_link" "#articles"
  "secondary_button_text" site.Params.hero.secondary_button
  "secondary_button_link" "#about"
  ) }}
  {{ end }}

  {{/* Carousel Slides */}}
  <div class="ti-hero-carousel">
    {{ range $index, $slide := $slides }}
    <div class="ti-hero-slide{{ if eq $index 0 }} active{{ end }}" data-slide="{{ $index }}">
      <div class="ti-hero-slide-bg">
        {{ with $slide.image }}
        <img src="{{ . | relURL }}" alt="{{ $slide.title }}">
        {{ else }}
        <div style="background: linear-gradient(135deg, hsl(0 0% 20%), hsl(0 0% 30%)); width: 100%; height: 100%;">
        </div>
        {{ end }}
      </div>
    </div>
    {{ end }}
  </div>

  {{/* Hero Content - Shows content of active slide */}}
  <div class="ti-hero-content" id="hero-content">
    {{ $firstSlide := index $slides 0 }}

    {{/* Badge */}}
    {{ with $firstSlide.badge }}
    <div class="ti-hero-badge" id="hero-badge">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
        <polyline points="17 6 23 6 23 12"></polyline>
      </svg>
      <span>{{ . }}</span>
    </div>
    {{ end }}

    {{/* Title */}}
    <h1 class="ti-hero-title" id="hero-title">
      {{ $firstSlide.title | safeHTML }}
    </h1>

    {{/* Subtitle */}}
    {{ with $firstSlide.subtitle }}
    <p class="ti-hero-subtitle" id="hero-subtitle">{{ . }}</p>
    {{ end }}

    {{/* Action Buttons */}}
    <div class="ti-hero-actions">
      {{ with $firstSlide.primary_button_text }}
      <a href="{{ $firstSlide.primary_button_link | default " #articles" }}" class="ti-btn ti-btn-primary ti-btn-lg"
        id="hero-primary-btn">
        {{ . }}
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <line x1="5" y1="12" x2="19" y2="12"></line>
          <polyline points="12 5 19 12 12 19"></polyline>
        </svg>
      </a>
      {{ end }}
      {{ with $firstSlide.secondary_button_text }}
      <a href="{{ $firstSlide.secondary_button_link | default " #about" }}" class="ti-btn ti-btn-outline ti-btn-lg"
        id="hero-secondary-btn">
        {{ . }}
      </a>
      {{ end }}
    </div>
  </div>

  {{/* Carousel Navigation Arrows */}}
  {{ if gt (len $slides) 1 }}
  <button class="ti-hero-arrow ti-hero-arrow-prev" onclick="prevSlide()" aria-label="Previous slide">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
  </button>
  <button class="ti-hero-arrow ti-hero-arrow-next" onclick="nextSlide()" aria-label="Next slide">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </button>

  {{/* Carousel Dots */}}
  <div class="ti-hero-controls">
    {{ range $index, $slide := $slides }}
    <button class="ti-hero-dot{{ if eq $index 0 }} active{{ end }}" onclick="goToSlide({{ $index }})"
      aria-label="Go to slide {{ add $index 1 }}"></button>
    {{ end }}
  </div>
  {{ end }}
</section>

{{/* Carousel Data for JavaScript */}}
<script>
  const heroSlides = {{ $slides | jsonify | safeJS }};
</script>
{{ end }}

{{/* About Section */}}
{{ if site.Params.about_section.enable }}
<section class="ti-about" id="about">
  <div class="ti-container">
    <div class="ti-about-wrapper">

      {{/* About Image */}}
      <div class="ti-about-image">
        {{ with site.Params.about_section.image }}
        <img src="{{ . | relURL }}" alt="{{ site.Params.about_section.title }}" loading="lazy">
        {{ end }}
        <div class="ti-about-decoration"></div>
      </div>

      {{/* About Content */}}
      <div class="ti-about-content">
        {{ with site.Params.about_section.subtitle }}
        <span class="ti-about-badge">{{ . }}</span>
        {{ end }}

        <h2 class="ti-section-title">{{ site.Params.about_section.title }}</h2>

        {{ with site.Params.about_section.content }}
        <p class="ti-about-text">{{ . | markdownify }}</p>
        {{ end }}

        {{ with site.Params.about_section.button_text }}
        <a href="{{ site.Params.about_section.button_link | default " #" }}" class="ti-btn ti-btn-primary ti-btn-lg">
          {{ . }}
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="5" y1="12" x2="19" y2="12"></line>
            <polyline points="12 5 19 12 12 19"></polyline>
          </svg>
        </a>
        {{ end }}
      </div>

    </div>
  </div>
</section>
{{ end }}

{{/* Featured Articles Section */}}
<section class="ti-articles" id="articles">
  <div class="ti-container">
    <div class="ti-section-header">
      <h2 class="ti-section-title">{{ i18n "featured_articles" | default "Featured Articles" }}</h2>
      <p class="ti-section-subtitle">{{ i18n "featured_articles_desc" | default "Latest and most popular tech content"
        }}</p>
    </div>

    <div class="ti-articles-grid">
      {{ $posts := where site.RegularPages "Section" "posts" }}
      {{ $posts = $posts.ByDate.Reverse }}
      {{ range first 6 $posts }}
      <article class="ti-article-card{{ if eq (index (first 1 $posts) 0) . }} featured{{ end }}">
        {{/* Image */}}
        <div class="ti-article-image">
          {{ with .Params.image }}
          <img src="{{ . | relURL }}" alt="{{ $.Title }}" onerror="this.onerror=null; this.src='/images/default.png';">
          {{ else }}
          <img src="/images/default.png" alt="{{ $.Title }}">
          {{ end }}

          {{/* Category Badge */}}
          {{ with .Params.categories }}
          <span class="ti-article-badge">{{ index . 0 | humanize }}</span>
          {{ end }}
        </div>

        {{/* Content */}}
        <div class="ti-article-content">
          <h3 class="ti-article-title">
            <a href="{{ .Permalink }}">{{ .Title }}</a>
          </h3>

          <p class="ti-article-excerpt">{{ .Summary | plainify | truncate 100 }}</p>

          {{/* Meta */}}
          <div class="ti-article-meta">
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              {{ .PublishDate.Format "Jan 02, 2006" }}
            </span>
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              {{ .ReadingTime }} {{ i18n "minute_read" | default "min" }}
            </span>
          </div>

          {{/* Read More Link */}}
          <a href="{{ .Permalink }}" class="ti-article-link">
            {{ i18n "read_more" | default "Read More" }}
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </a>
        </div>
      </article>
      {{ else }}
      <p class="ti-text-center" style="grid-column: span 2; padding: 3rem;">
        {{ i18n "no_posts_found" | default "No posts found" }}
      </p>
      {{ end }}
    </div>
  </div>
</section>

{{/* Categories Section - Dynamic from Hugo Taxonomy */}}
{{ with site.Taxonomies.categories }}
{{ if gt (len .) 0 }}
<section class="ti-categories" id="categories">
  <div class="ti-container">
    <div class="ti-section-header ti-text-center">
      <h2 class="ti-section-title">{{ i18n "explore_topics" | default "Explore Topics" }}</h2>
      <p class="ti-section-subtitle">{{ i18n "explore_topics_desc" | default "Browse articles by category" }}</p>
    </div>

    <div class="ti-categories-grid">
      {{/* Sort categories by count (descending) and take top 6 */}}
      {{ $categories := slice }}
      {{ range $name, $pages := . }}
      {{ $categories = $categories | append (dict "name" $name "count" (len $pages)) }}
      {{ end }}
      {{ $sorted := sort $categories "count" "desc" }}
      {{ range first 6 $sorted }}
      {{ $catName := .name }}
      {{ $catCount := .count }}
      <a href="{{ printf "categories/%s/" $catName | relLangURL }}" class="ti-category-card">
        <div class="ti-category-icon">
          {{/* Dynamic icon based on category name */}}
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
          </svg>
        </div>
        <div>
          <h3 class="ti-category-name">{{ $catName | humanize | title }}</h3>
          <p class="ti-category-count">{{ $catCount }} {{ if eq $catCount 1 }}{{ i18n "post" | default "post" }}{{ else
            }}{{ i18n "posts" | default "posts" }}{{ end }}</p>
        </div>
      </a>
      {{ end }}
    </div>
  </div>
</section>
{{ end }}
{{ end }}

{{/* Newsletter Section */}}
{{ if site.Params.newsletter.enable }}
<section class="ti-newsletter" id="newsletter">
  <div class="ti-container">
    <div class="ti-newsletter-content">
      <div class="ti-newsletter-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
          <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
      </div>

      <h2 class="ti-newsletter-title">{{ site.Params.newsletter.title }}</h2>
      <p class="ti-newsletter-subtitle">{{ site.Params.newsletter.subtitle }}</p>

      <form class="ti-newsletter-form" action="#" method="post">
        <input type="email" class="ti-newsletter-input" placeholder="{{ site.Params.newsletter.placeholder }}" required>
        <button type="submit" class="ti-btn ti-btn-primary">
          {{ site.Params.newsletter.button }}
        </button>
      </form>

      <p class="ti-newsletter-disclaimer">{{ site.Params.newsletter.disclaimer }}</p>
    </div>
  </div>
</section>
{{ end }}

{{/* Hero Carousel JavaScript */}}
{{ if site.Params.hero.enable }}
<script>
  (function () {
    // Carousel state
    let currentSlide = 0;
    let autoplayTimer = null;
    const autoplayInterval = {{ site.Params.hero.autoplay_interval | default 6000
  }};

  // Get elements
  const slides = document.querySelectorAll('.ti-hero-slide');
  const dots = document.querySelectorAll('.ti-hero-dot');

  if (slides.length <= 1) return; // No carousel needed for single slide

  // Update slide content
  function updateContent(slideIndex) {
    if (typeof heroSlides === 'undefined' || !heroSlides[slideIndex]) return;

    const slide = heroSlides[slideIndex];
    const titleEl = document.getElementById('hero-title');
    const subtitleEl = document.getElementById('hero-subtitle');
    const badgeEl = document.getElementById('hero-badge');
    const primaryBtn = document.getElementById('hero-primary-btn');
    const secondaryBtn = document.getElementById('hero-secondary-btn');

    if (titleEl && slide.title) titleEl.innerHTML = slide.title;
    if (subtitleEl && slide.subtitle) subtitleEl.textContent = slide.subtitle;
    if (badgeEl && slide.badge) {
      const badgeSpan = badgeEl.querySelector('span');
      if (badgeSpan) badgeSpan.textContent = slide.badge;
    }
    if (primaryBtn && slide.primary_button_text) {
      primaryBtn.firstChild.textContent = slide.primary_button_text;
      if (slide.primary_button_link) primaryBtn.href = slide.primary_button_link;
    }
    if (secondaryBtn && slide.secondary_button_text) {
      secondaryBtn.textContent = slide.secondary_button_text;
      if (slide.secondary_button_link) secondaryBtn.href = slide.secondary_button_link;
    }
  }

  // Go to specific slide
  window.goToSlide = function (index) {
    slides[currentSlide].classList.remove('active');
    dots[currentSlide].classList.remove('active');

    currentSlide = index;
    if (currentSlide >= slides.length) currentSlide = 0;
    if (currentSlide < 0) currentSlide = slides.length - 1;

    slides[currentSlide].classList.add('active');
    dots[currentSlide].classList.add('active');

    updateContent(currentSlide);
    resetAutoplay();
  };

  // Next slide
  window.nextSlide = function () {
    goToSlide(currentSlide + 1);
  };

  // Previous slide
  window.prevSlide = function () {
    goToSlide(currentSlide - 1);
  };

  // Autoplay functions
  function startAutoplay() {
    if (autoplayInterval > 0) {
      autoplayTimer = setInterval(nextSlide, autoplayInterval);
    }
  }

  function resetAutoplay() {
    if (autoplayTimer) {
      clearInterval(autoplayTimer);
      startAutoplay();
    }
  }

  // Pause on hover
  const heroSection = document.querySelector('.ti-hero');
  if (heroSection) {
    heroSection.addEventListener('mouseenter', function () {
      if (autoplayTimer) clearInterval(autoplayTimer);
    });
    heroSection.addEventListener('mouseleave', startAutoplay);
  }

  // Keyboard navigation
  document.addEventListener('keydown', function (e) {
    if (e.key === 'ArrowLeft') prevSlide();
    if (e.key === 'ArrowRight') nextSlide();
  });

  // Start autoplay
  startAutoplay();
}) ();
</script>
{{ end }}

{{ end }}